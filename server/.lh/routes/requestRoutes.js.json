{
    "sourceFile": "routes/requestRoutes.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 7,
            "patches": [
                {
                    "date": 1754448071692,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1754458808887,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,19 +2,19 @@\n const express = require('express');\r\n const router = express.Router();\r\n const db = require('../config/db'); // ปรับตาม path จริงของคุณ\r\n \r\n-// GET /api/my-requests/:userId\r\n+// ✅ ดึงคำขอของผู้ใช้เฉพาะ userId\r\n router.get('/my-requests/:userId', async (req, res) => {\r\n   const { userId } = req.params;\r\n \r\n   try {\r\n     const [rows] = await db.query(`\r\n-      SELECT br.id, br.reason, br.status, br.created_at, d.name AS device_name\r\n+      SELECT br.id, br.reason, br.status, br.request_date, d.name AS device_name\r\n       FROM borrow_requests br\r\n       JOIN devices d ON br.device_id = d.id\r\n       WHERE br.user_id = ?\r\n-      ORDER BY br.created_at DESC\r\n+      ORDER BY br.request_date DESC\r\n     `, [userId]);\r\n \r\n     res.json(rows);\r\n   } catch (err) {\r\n@@ -22,5 +22,61 @@\n     res.status(500).json({ error: 'เกิดข้อผิดพลาดในการดึงข้อมูล' });\r\n   }\r\n });\r\n \r\n+// ✅ ดึงคำขอทั้งหมดที่รออนุมัติ (สำหรับ admin)\r\n+router.get('/borrow-requests/pending', async (req, res) => {\r\n+  try {\r\n+    const [rows] = await db.query(`\r\n+      SELECT br.id, br.reason, br.status, br.request_date, u.username, d.name AS device_name\r\n+      FROM borrow_requests br\r\n+      JOIN users u ON br.user_id = u.id\r\n+      JOIN devices d ON br.device_id = d.id\r\n+      WHERE br.status = 'pending'\r\n+      ORDER BY br.request_date DESC\r\n+    `);\r\n+\r\n+    res.json(rows);\r\n+  } catch (err) {\r\n+    console.error('Error fetching pending requests:', err);\r\n+    res.status(500).json({ error: 'เกิดข้อผิดพลาดในการดึงคำขอ pending' });\r\n+  }\r\n+});\r\n+\r\n+// ✅ อนุมัติคำขอ\r\n+router.post('/borrow-requests/approve/:id', async (req, res) => {\r\n+  const { id } = req.params;\r\n+\r\n+  try {\r\n+    await db.query(`\r\n+      UPDATE borrow_requests\r\n+      SET status = 'approved', approve_date = NOW()\r\n+      WHERE id = ?\r\n+    `, [id]);\r\n+\r\n+    res.json({ message: 'อนุมัติเรียบร้อยแล้ว' });\r\n+  } catch (err) {\r\n+    console.error('Error approving request:', err);\r\n+    res.status(500).json({ error: 'เกิดข้อผิดพลาดในการอนุมัติ' });\r\n+  }\r\n+});\r\n+\r\n+// ✅ ปฏิเสธคำขอ\r\n+router.post('/borrow-requests/reject/:id', async (req, res) => {\r\n+  const { id } = req.params;\r\n+\r\n+  try {\r\n+    await db.query(`\r\n+      UPDATE borrow_requests\r\n+      SET status = 'rejected', approve_date = NOW()\r\n+      WHERE id = ?\r\n+    `, [id]);\r\n+\r\n+    res.json({ message: 'ปฏิเสธเรียบร้อยแล้ว' });\r\n+  } catch (err) {\r\n+    console.error('Error rejecting request:', err);\r\n+    res.status(500).json({ error: 'เกิดข้อผิดพลาดในการปฏิเสธ' });\r\n+  }\r\n+});\r\n+\r\n+// ✅ export router\r\n module.exports = router;\r\n"
                },
                {
                    "date": 1754461275310,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,18 +1,42 @@\n-// routes/requestRoutes.js\r\n const express = require('express');\r\n const router = express.Router();\r\n-const db = require('../config/db'); // ปรับตาม path จริงของคุณ\r\n+const db = require('../config/db');\r\n \r\n-// ✅ ดึงคำขอของผู้ใช้เฉพาะ userId\r\n+// ✅ POST: ส่งคำขอยืม\r\n+router.post('/borrow-requests', async (req, res) => {\r\n+  const { user_id, device_id, reason } = req.body;\r\n+\r\n+  try {\r\n+    await db.query(`\r\n+      INSERT INTO borrow_requests (user_id, device_id, reason, status, request_date)\r\n+      VALUES (?, ?, ?, 'pending', NOW())\r\n+    `, [user_id, device_id, reason]);\r\n+\r\n+    res.json({ message: 'ส่งคำขอเรียบร้อยแล้ว' });\r\n+  } catch (err) {\r\n+    console.error('Error submitting request:', err);\r\n+    res.status(500).json({ error: 'เกิดข้อผิดพลาดในการส่งคำขอ' });\r\n+  }\r\n+});\r\n+\r\n+// ✅ GET: คำขอของ user คนเดียว\r\n router.get('/my-requests/:userId', async (req, res) => {\r\n   const { userId } = req.params;\r\n \r\n   try {\r\n     const [rows] = await db.query(`\r\n-      SELECT br.id, br.reason, br.status, br.request_date, d.name AS device_name\r\n+      SELECT \r\n+        br.id, \r\n+        br.reason, \r\n+        br.status, \r\n+        br.request_date, \r\n+        br.approve_date,\r\n+        d.name AS device_name,\r\n+        u.username\r\n       FROM borrow_requests br\r\n       JOIN devices d ON br.device_id = d.id\r\n+      JOIN users u ON br.user_id = u.id\r\n       WHERE br.user_id = ?\r\n       ORDER BY br.request_date DESC\r\n     `, [userId]);\r\n \r\n@@ -22,13 +46,20 @@\n     res.status(500).json({ error: 'เกิดข้อผิดพลาดในการดึงข้อมูล' });\r\n   }\r\n });\r\n \r\n-// ✅ ดึงคำขอทั้งหมดที่รออนุมัติ (สำหรับ admin)\r\n+// ✅ GET: คำขอที่รออนุมัติ (admin)\r\n router.get('/borrow-requests/pending', async (req, res) => {\r\n   try {\r\n     const [rows] = await db.query(`\r\n-      SELECT br.id, br.reason, br.status, br.request_date, u.username, d.name AS device_name\r\n+      SELECT \r\n+        br.id, \r\n+        br.reason, \r\n+        br.status, \r\n+        br.request_date, \r\n+        br.approve_date,\r\n+        u.username, \r\n+        d.name AS device_name\r\n       FROM borrow_requests br\r\n       JOIN users u ON br.user_id = u.id\r\n       JOIN devices d ON br.device_id = d.id\r\n       WHERE br.status = 'pending'\r\n@@ -41,9 +72,9 @@\n     res.status(500).json({ error: 'เกิดข้อผิดพลาดในการดึงคำขอ pending' });\r\n   }\r\n });\r\n \r\n-// ✅ อนุมัติคำขอ\r\n+// ✅ POST: อนุมัติ\r\n router.post('/borrow-requests/approve/:id', async (req, res) => {\r\n   const { id } = req.params;\r\n \r\n   try {\r\n@@ -59,9 +90,9 @@\n     res.status(500).json({ error: 'เกิดข้อผิดพลาดในการอนุมัติ' });\r\n   }\r\n });\r\n \r\n-// ✅ ปฏิเสธคำขอ\r\n+// ✅ POST: ปฏิเสธ\r\n router.post('/borrow-requests/reject/:id', async (req, res) => {\r\n   const { id } = req.params;\r\n \r\n   try {\r\n@@ -77,6 +108,5 @@\n     res.status(500).json({ error: 'เกิดข้อผิดพลาดในการปฏิเสธ' });\r\n   }\r\n });\r\n \r\n-// ✅ export router\r\n module.exports = router;\r\n"
                },
                {
                    "date": 1754534864641,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -33,10 +33,10 @@\n         br.approve_date,\r\n         d.name AS device_name,\r\n         u.username\r\n       FROM borrow_requests br\r\n-      JOIN devices d ON br.device_id = d.id\r\n-      JOIN users u ON br.user_id = u.id\r\n+      LEFT JOIN devices d ON br.device_id = d.id\r\n+      LEFT JOIN users u ON br.user_id = u.id\r\n       WHERE br.user_id = ?\r\n       ORDER BY br.request_date DESC\r\n     `, [userId]);\r\n \r\n@@ -46,8 +46,33 @@\n     res.status(500).json({ error: 'เกิดข้อผิดพลาดในการดึงข้อมูล' });\r\n   }\r\n });\r\n \r\n+// ✅ GET: คำขอทั้งหมด (admin หรือใช้ใน AllBorrowRequests.jsx)\r\n+router.get('/borrow-requests', async (req, res) => {\r\n+  try {\r\n+    const [rows] = await db.query(`\r\n+      SELECT \r\n+        br.id,\r\n+        br.reason,\r\n+        br.status,\r\n+        br.request_date,\r\n+        br.approve_date,\r\n+        u.username,\r\n+        d.name AS device_name\r\n+      FROM borrow_requests br\r\n+      LEFT JOIN users u ON br.user_id = u.id\r\n+      LEFT JOIN devices d ON br.device_id = d.id\r\n+      ORDER BY br.request_date DESC\r\n+    `);\r\n+\r\n+    res.json(rows);\r\n+  } catch (err) {\r\n+    console.error('Error fetching all borrow requests:', err);\r\n+    res.status(500).json({ error: 'เกิดข้อผิดพลาดในการดึงข้อมูลคำขอทั้งหมด' });\r\n+  }\r\n+});\r\n+\r\n // ✅ GET: คำขอที่รออนุมัติ (admin)\r\n router.get('/borrow-requests/pending', async (req, res) => {\r\n   try {\r\n     const [rows] = await db.query(`\r\n@@ -59,10 +84,10 @@\n         br.approve_date,\r\n         u.username, \r\n         d.name AS device_name\r\n       FROM borrow_requests br\r\n-      JOIN users u ON br.user_id = u.id\r\n-      JOIN devices d ON br.device_id = d.id\r\n+      LEFT JOIN users u ON br.user_id = u.id\r\n+      LEFT JOIN devices d ON br.device_id = d.id\r\n       WHERE br.status = 'pending'\r\n       ORDER BY br.request_date DESC\r\n     `);\r\n \r\n@@ -72,9 +97,9 @@\n     res.status(500).json({ error: 'เกิดข้อผิดพลาดในการดึงคำขอ pending' });\r\n   }\r\n });\r\n \r\n-// ✅ POST: อนุมัติ\r\n+// ✅ POST: อนุมัติคำขอ\r\n router.post('/borrow-requests/approve/:id', async (req, res) => {\r\n   const { id } = req.params;\r\n \r\n   try {\r\n@@ -90,9 +115,9 @@\n     res.status(500).json({ error: 'เกิดข้อผิดพลาดในการอนุมัติ' });\r\n   }\r\n });\r\n \r\n-// ✅ POST: ปฏิเสธ\r\n+// ✅ POST: ปฏิเสธคำขอ\r\n router.post('/borrow-requests/reject/:id', async (req, res) => {\r\n   const { id } = req.params;\r\n \r\n   try {\r\n"
                },
                {
                    "date": 1754535100267,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -41,14 +41,14 @@\n     `, [userId]);\r\n \r\n     res.json(rows);\r\n   } catch (err) {\r\n-    console.error('Error fetching requests:', err);\r\n-    res.status(500).json({ error: 'เกิดข้อผิดพลาดในการดึงข้อมูล' });\r\n+    console.error('Error fetching user requests:', err);\r\n+    res.status(500).json({ error: 'เกิดข้อผิดพลาดในการดึงข้อมูลคำขอของผู้ใช้' });\r\n   }\r\n });\r\n \r\n-// ✅ GET: คำขอทั้งหมด (admin หรือใช้ใน AllBorrowRequests.jsx)\r\n+// ✅ GET: คำขอทั้งหมด (admin)\r\n router.get('/borrow-requests', async (req, res) => {\r\n   try {\r\n     const [rows] = await db.query(`\r\n       SELECT \r\n@@ -71,9 +71,9 @@\n     res.status(500).json({ error: 'เกิดข้อผิดพลาดในการดึงข้อมูลคำขอทั้งหมด' });\r\n   }\r\n });\r\n \r\n-// ✅ GET: คำขอที่รออนุมัติ (admin)\r\n+// ✅ GET: เฉพาะคำขอที่รออนุมัติ\r\n router.get('/borrow-requests/pending', async (req, res) => {\r\n   try {\r\n     const [rows] = await db.query(`\r\n       SELECT \r\n@@ -97,41 +97,28 @@\n     res.status(500).json({ error: 'เกิดข้อผิดพลาดในการดึงคำขอ pending' });\r\n   }\r\n });\r\n \r\n-// ✅ POST: อนุมัติคำขอ\r\n-router.post('/borrow-requests/approve/:id', async (req, res) => {\r\n+// ✅ PUT: อัปเดตสถานะ (อนุมัติ / ปฏิเสธ)\r\n+router.put('/borrow-requests/:id', async (req, res) => {\r\n   const { id } = req.params;\r\n+  const { status } = req.body;\r\n \r\n-  try {\r\n-    await db.query(`\r\n-      UPDATE borrow_requests\r\n-      SET status = 'approved', approve_date = NOW()\r\n-      WHERE id = ?\r\n-    `, [id]);\r\n-\r\n-    res.json({ message: 'อนุมัติเรียบร้อยแล้ว' });\r\n-  } catch (err) {\r\n-    console.error('Error approving request:', err);\r\n-    res.status(500).json({ error: 'เกิดข้อผิดพลาดในการอนุมัติ' });\r\n+  if (!['approved', 'rejected'].includes(status)) {\r\n+    return res.status(400).json({ error: 'สถานะไม่ถูกต้อง (ต้องเป็น approved หรือ rejected)' });\r\n   }\r\n-});\r\n \r\n-// ✅ POST: ปฏิเสธคำขอ\r\n-router.post('/borrow-requests/reject/:id', async (req, res) => {\r\n-  const { id } = req.params;\r\n-\r\n   try {\r\n     await db.query(`\r\n       UPDATE borrow_requests\r\n-      SET status = 'rejected', approve_date = NOW()\r\n+      SET status = ?, approve_date = NOW()\r\n       WHERE id = ?\r\n-    `, [id]);\r\n+    `, [status, id]);\r\n \r\n-    res.json({ message: 'ปฏิเสธเรียบร้อยแล้ว' });\r\n+    res.json({ message: `อัปเดตสถานะเป็น ${status} สำเร็จ` });\r\n   } catch (err) {\r\n-    console.error('Error rejecting request:', err);\r\n-    res.status(500).json({ error: 'เกิดข้อผิดพลาดในการปฏิเสธ' });\r\n+    console.error('Error updating status:', err);\r\n+    res.status(500).json({ error: 'เกิดข้อผิดพลาดในการอัปเดตสถานะ' });\r\n   }\r\n });\r\n \r\n module.exports = router;\r\n"
                },
                {
                    "date": 1754535118226,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -41,14 +41,14 @@\n     `, [userId]);\r\n \r\n     res.json(rows);\r\n   } catch (err) {\r\n-    console.error('Error fetching user requests:', err);\r\n-    res.status(500).json({ error: 'เกิดข้อผิดพลาดในการดึงข้อมูลคำขอของผู้ใช้' });\r\n+    console.error('Error fetching requests:', err);\r\n+    res.status(500).json({ error: 'เกิดข้อผิดพลาดในการดึงข้อมูล' });\r\n   }\r\n });\r\n \r\n-// ✅ GET: คำขอทั้งหมด (admin)\r\n+// ✅ GET: คำขอทั้งหมด (admin หรือใช้ใน AllBorrowRequests.jsx)\r\n router.get('/borrow-requests', async (req, res) => {\r\n   try {\r\n     const [rows] = await db.query(`\r\n       SELECT \r\n@@ -71,9 +71,9 @@\n     res.status(500).json({ error: 'เกิดข้อผิดพลาดในการดึงข้อมูลคำขอทั้งหมด' });\r\n   }\r\n });\r\n \r\n-// ✅ GET: เฉพาะคำขอที่รออนุมัติ\r\n+// ✅ GET: คำขอที่รออนุมัติ (admin)\r\n router.get('/borrow-requests/pending', async (req, res) => {\r\n   try {\r\n     const [rows] = await db.query(`\r\n       SELECT \r\n@@ -97,28 +97,41 @@\n     res.status(500).json({ error: 'เกิดข้อผิดพลาดในการดึงคำขอ pending' });\r\n   }\r\n });\r\n \r\n-// ✅ PUT: อัปเดตสถานะ (อนุมัติ / ปฏิเสธ)\r\n-router.put('/borrow-requests/:id', async (req, res) => {\r\n+// ✅ POST: อนุมัติคำขอ\r\n+router.post('/borrow-requests/approve/:id', async (req, res) => {\r\n   const { id } = req.params;\r\n-  const { status } = req.body;\r\n \r\n-  if (!['approved', 'rejected'].includes(status)) {\r\n-    return res.status(400).json({ error: 'สถานะไม่ถูกต้อง (ต้องเป็น approved หรือ rejected)' });\r\n+  try {\r\n+    await db.query(`\r\n+      UPDATE borrow_requests\r\n+      SET status = 'approved', approve_date = NOW()\r\n+      WHERE id = ?\r\n+    `, [id]);\r\n+\r\n+    res.json({ message: 'อนุมัติเรียบร้อยแล้ว' });\r\n+  } catch (err) {\r\n+    console.error('Error approving request:', err);\r\n+    res.status(500).json({ error: 'เกิดข้อผิดพลาดในการอนุมัติ' });\r\n   }\r\n+});\r\n \r\n+// ✅ POST: ปฏิเสธคำขอ\r\n+router.post('/borrow-requests/reject/:id', async (req, res) => {\r\n+  const { id } = req.params;\r\n+\r\n   try {\r\n     await db.query(`\r\n       UPDATE borrow_requests\r\n-      SET status = ?, approve_date = NOW()\r\n+      SET status = 'rejected', approve_date = NOW()\r\n       WHERE id = ?\r\n-    `, [status, id]);\r\n+    `, [id]);\r\n \r\n-    res.json({ message: `อัปเดตสถานะเป็น ${status} สำเร็จ` });\r\n+    res.json({ message: 'ปฏิเสธเรียบร้อยแล้ว' });\r\n   } catch (err) {\r\n-    console.error('Error updating status:', err);\r\n-    res.status(500).json({ error: 'เกิดข้อผิดพลาดในการอัปเดตสถานะ' });\r\n+    console.error('Error rejecting request:', err);\r\n+    res.status(500).json({ error: 'เกิดข้อผิดพลาดในการปฏิเสธ' });\r\n   }\r\n });\r\n \r\n module.exports = router;\r\n"
                },
                {
                    "date": 1754552436435,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -134,4 +134,5 @@\n   }\r\n });\r\n \r\n module.exports = router;\r\n+\r\n"
                },
                {
                    "date": 1754552449436,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -134,5 +134,4 @@\n   }\r\n });\r\n \r\n module.exports = router;\r\n-\r\n"
                }
            ],
            "date": 1754448071692,
            "name": "Commit-0",
            "content": "// routes/requestRoutes.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\nconst db = require('../config/db'); // ปรับตาม path จริงของคุณ\r\n\r\n// GET /api/my-requests/:userId\r\nrouter.get('/my-requests/:userId', async (req, res) => {\r\n  const { userId } = req.params;\r\n\r\n  try {\r\n    const [rows] = await db.query(`\r\n      SELECT br.id, br.reason, br.status, br.created_at, d.name AS device_name\r\n      FROM borrow_requests br\r\n      JOIN devices d ON br.device_id = d.id\r\n      WHERE br.user_id = ?\r\n      ORDER BY br.created_at DESC\r\n    `, [userId]);\r\n\r\n    res.json(rows);\r\n  } catch (err) {\r\n    console.error('Error fetching requests:', err);\r\n    res.status(500).json({ error: 'เกิดข้อผิดพลาดในการดึงข้อมูล' });\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"
        }
    ]
}