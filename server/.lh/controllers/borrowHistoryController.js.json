{
    "sourceFile": "controllers/borrowHistoryController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 21,
            "patches": [
                {
                    "date": 1754818141434,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1754818147136,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-const pool = require('../config/db'); // สมมติคุณสร้าง pool ไว้ที่นี่\r\n+const pool = require('../config/db'); \r\n \r\n const getBorrowHistoryWithDevice = async (req, res) => {\r\n   try {\r\n     const sql = `\r\n"
                },
                {
                    "date": 1754818903969,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,4 +1,5 @@\n+// controllers/borrowHistoryController.js\r\n const pool = require('../config/db'); \r\n \r\n const getBorrowHistoryWithDevice = async (req, res) => {\r\n   try {\r\n@@ -14,9 +15,9 @@\n         bh.reason,\r\n         bh.borrowed_at,\r\n         bh.returned_at\r\n       FROM devices d\r\n-      LEFT JOIN borrow_history bh ON bh.device_id = d.id\r\n+      INNER JOIN borrow_history bh ON bh.device_id = d.id\r\n       ORDER BY bh.borrowed_at DESC\r\n     `;\r\n \r\n     const [rows] = await pool.query(sql);\r\n"
                },
                {
                    "date": 1754819036081,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,9 +4,10 @@\n const getBorrowHistoryWithDevice = async (req, res) => {\r\n   try {\r\n     const sql = `\r\n       SELECT\r\n-        d.type,\r\n+        d.id,\r\n+        dt.type_name,\r\n         d.name AS device_name,\r\n         d.brand,\r\n         d.id_code,\r\n         d.serial_number,\r\n@@ -16,8 +17,9 @@\n         bh.borrowed_at,\r\n         bh.returned_at\r\n       FROM devices d\r\n       INNER JOIN borrow_history bh ON bh.device_id = d.id\r\n+      LEFT JOIN device_types dt ON d.type = dt.id\r\n       ORDER BY bh.borrowed_at DESC\r\n     `;\r\n \r\n     const [rows] = await pool.query(sql);\r\n"
                },
                {
                    "date": 1754910766240,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,36 @@\n+// controllers/borrowHistoryController.js\r\n+const pool = require('../config/db'); \r\n+\r\n+const getBorrowHistoryWithDevice = async (req, res) => {\r\n+  try {\r\n+    const sql = `\r\n+      SELECT\r\n+        d.id,\r\n+        dt.type_name,\r\n+        d.name AS device_name,\r\n+        db.brand_name,\r\n+        d.id_code,\r\n+        d.serial_number,\r\n+        bh.borrower_name,\r\n+        bh.department,\r\n+        bh.reason,\r\n+        bh.borrowed_at,\r\n+        bh.returned_at\r\n+      FROM devices d\r\n+      INNER JOIN borrow_history bh ON bh.device_id = d.id\r\n+      LEFT JOIN device_types dt ON d.type = dt.id\r\n+      LEFT JOIN device_brand db ON d.brand_id = db.id\r\n+      ORDER BY bh.borrowed_at DESC\r\n+    `;\r\n+\r\n+    const [rows] = await pool.query(sql);\r\n+    res.json(rows);\r\n+  } catch (error) {\r\n+    console.error('Error in getBorrowHistoryWithDevice:', error);\r\n+    res.status(500).json({ message: 'Internal Server Error' });\r\n+  }\r\n+};\r\n+\r\n+module.exports = {\r\n+  getBorrowHistoryWithDevice,\r\n+};\r\n"
                },
                {
                    "date": 1754911327449,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,44 +7,8 @@\n       SELECT\r\n         d.id,\r\n         dt.type_name,\r\n         d.name AS device_name,\r\n-        db.brand_name,\r\n-        d.id_code,\r\n-        d.serial_number,\r\n-        bh.borrower_name,\r\n-        bh.department,\r\n-        bh.reason,\r\n-        bh.borrowed_at,\r\n-        bh.returned_at\r\n-      FROM devices d\r\n-      INNER JOIN borrow_history bh ON bh.device_id = d.id\r\n-      LEFT JOIN device_types dt ON d.type = dt.id\r\n-      LEFT JOIN device_brand db ON d.brand_id = db.id\r\n-      ORDER BY bh.borrowed_at DESC\r\n-    `;\r\n-\r\n-    const [rows] = await pool.query(sql);\r\n-    res.json(rows);\r\n-  } catch (error) {\r\n-    console.error('Error in getBorrowHistoryWithDevice:', error);\r\n-    res.status(500).json({ message: 'Internal Server Error' });\r\n-  }\r\n-};\r\n-\r\n-module.exports = {\r\n-  getBorrowHistoryWithDevice,\r\n-};\r\n-// controllers/borrowHistoryController.js\r\n-const pool = require('../config/db'); \r\n-\r\n-const getBorrowHistoryWithDevice = async (req, res) => {\r\n-  try {\r\n-    const sql = `\r\n-      SELECT\r\n-        d.id,\r\n-        dt.type_name,\r\n-        d.name AS device_name,\r\n         d.brand,\r\n         d.id_code,\r\n         d.serial_number,\r\n         bh.borrower_name,\r\n"
                },
                {
                    "date": 1754935837552,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,8 +8,9 @@\n         d.id,\r\n         dt.type_name,\r\n         d.name AS device_name,\r\n         d.brand,\r\n+        db.brand_name,\r\n         d.id_code,\r\n         d.serial_number,\r\n         bh.borrower_name,\r\n         bh.department,\r\n@@ -18,8 +19,9 @@\n         bh.returned_at\r\n       FROM devices d\r\n       INNER JOIN borrow_history bh ON bh.device_id = d.id\r\n       LEFT JOIN device_types dt ON d.type = dt.id\r\n+      LEFT JOIN device_brand db ON d.brand = db.id\r\n       ORDER BY bh.borrowed_at DESC\r\n     `;\r\n \r\n     const [rows] = await pool.query(sql);\r\n"
                },
                {
                    "date": 1755053351712,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,6 @@\n // controllers/borrowHistoryController.js\r\n-const pool = require('../config/db'); \r\n+const db = require('../config/db');\r\n \r\n const getBorrowHistoryWithDevice = async (req, res) => {\r\n   try {\r\n     const sql = `\r\n"
                },
                {
                    "date": 1755053389265,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,6 @@\n // controllers/borrowHistoryController.js\r\n-const db = require('../config/db');\r\n+const pool = require('../config/db'); \r\n \r\n const getBorrowHistoryWithDevice = async (req, res) => {\r\n   try {\r\n     const sql = `\r\n"
                },
                {
                    "date": 1755062973644,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,57 @@\n+// controllers/borrowHistoryController.js\r\n+const pool = require('../config/db'); \r\n+\r\n+const getBorrowHistoryWithDevice = async (req, res) => {\r\n+  try {\r\n+    const sql = `\r\n+      SELECT\r\n+        d.id,\r\n+        dt.type_name,\r\n+        d.name AS device_name,\r\n+        d.brand,\r\n+        db.brand_name,\r\n+        d.id_code,\r\n+        d.serial_number,\r\n+        bh.borrower_name,\r\n+        bh.department,\r\n+        bh.reason,\r\n+        bh.borrowed_at,\r\n+        bh.returned_at\r\n+      FROM devices d\r\n+      INNER JOIN borrow_history bh ON bh.device_id = d.id\r\n+      LEFT JOIN device_types dt ON d.type = dt.id\r\n+      LEFT JOIN device_brand db ON d.brand = db.id\r\n+      ORDER BY bh.borrowed_at DESC\r\n+    `;\r\n+\r\n+    const [rows] = await pool.query(sql);\r\n+    res.json(rows);\r\n+  } catch (error) {\r\n+    console.error('Error in getBorrowHistoryWithDevice:', error);\r\n+    res.status(500).json({ message: 'Internal Server Error' });\r\n+  }\r\n+};\r\n+\r\n+// ดึงรายการ brand ทั้งหมด\r\n+exports.getAllBrands = async (req, res) => {\r\n+  try {\r\n+    const [brands] = await db.query('SELECT * FROM device_brand');\r\n+    res.json(brands);\r\n+  } catch (err) {\r\n+    res.status(500).json({ message: 'ดึงข้อมูล brand ไม่สำเร็จ', error: err.message });\r\n+  }\r\n+};\r\n+\r\n+// ดึงรายการ type ทั้งหมด\r\n+exports.getAllTypes = async (req, res) => {\r\n+  try {\r\n+    const [types] = await db.query('SELECT * FROM device_types');\r\n+    res.json(types);\r\n+  } catch (err) {\r\n+    res.status(500).json({ message: 'ดึงข้อมูล type ไม่สำเร็จ', error: err.message });\r\n+  }\r\n+};\r\n+\r\n+module.exports = {\r\n+  getBorrowHistoryWithDevice,\r\n+};\r\n"
                },
                {
                    "date": 1755097619822,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,16 +1,16 @@\n-// controllers/borrowHistoryController.js\r\n const pool = require('../config/db'); \r\n \r\n const getBorrowHistoryWithDevice = async (req, res) => {\r\n   try {\r\n     const sql = `\r\n       SELECT\r\n         d.id,\r\n-        dt.type_name,\r\n         d.name AS device_name,\r\n         d.brand,\r\n-        db.brand_name,\r\n+        db.name AS brand_name,\r\n+        d.type,\r\n+        dt.name AS type_name,\r\n         d.id_code,\r\n         d.serial_number,\r\n         bh.borrower_name,\r\n         bh.department,\r\n@@ -22,73 +22,15 @@\n       LEFT JOIN device_types dt ON d.type = dt.id\r\n       LEFT JOIN device_brand db ON d.brand = db.id\r\n       ORDER BY bh.borrowed_at DESC\r\n     `;\r\n-\r\n     const [rows] = await pool.query(sql);\r\n     res.json(rows);\r\n   } catch (error) {\r\n     console.error('Error in getBorrowHistoryWithDevice:', error);\r\n     res.status(500).json({ message: 'Internal Server Error' });\r\n   }\r\n };\r\n \r\n-// ดึงรายการ brand ทั้งหมด\r\n-exports.getAllBrands = async (req, res) => {\r\n-  try {\r\n-    const [brands] = await db.query('SELECT * FROM device_brand');\r\n-    res.json(brands);\r\n-  } catch (err) {\r\n-    res.status(500).json({ message: 'ดึงข้อมูล brand ไม่สำเร็จ', error: err.message });\r\n-  }\r\n-};\r\n-\r\n-// ดึงรายการ type ทั้งหมด\r\n-exports.getAllTypes = async (req, res) => {\r\n-  try {\r\n-    const [types] = await db.query('SELECT * FROM device_types');\r\n-    res.json(types);\r\n-  } catch (err) {\r\n-    res.status(500).json({ message: 'ดึงข้อมูล type ไม่สำเร็จ', error: err.message });\r\n-  }\r\n-};\r\n-\r\n module.exports = {\r\n   getBorrowHistoryWithDevice,\r\n };\r\n-// controllers/borrowHistoryController.js\r\n-const pool = require('../config/db'); \r\n-\r\n-const getBorrowHistoryWithDevice = async (req, res) => {\r\n-  try {\r\n-    const sql = `\r\n-      SELECT\r\n-        d.id,\r\n-        dt.type_name,\r\n-        d.name AS device_name,\r\n-        d.brand,\r\n-        db.brand_name,\r\n-        d.id_code,\r\n-        d.serial_number,\r\n-        bh.borrower_name,\r\n-        bh.department,\r\n-        bh.reason,\r\n-        bh.borrowed_at,\r\n-        bh.returned_at\r\n-      FROM devices d\r\n-      INNER JOIN borrow_history bh ON bh.device_id = d.id\r\n-      LEFT JOIN device_types dt ON d.type = dt.id\r\n-      LEFT JOIN device_brand db ON d.brand = db.id\r\n-      ORDER BY bh.borrowed_at DESC\r\n-    `;\r\n-\r\n-    const [rows] = await pool.query(sql);\r\n-    res.json(rows);\r\n-  } catch (error) {\r\n-    console.error('Error in getBorrowHistoryWithDevice:', error);\r\n-    res.status(500).json({ message: 'Internal Server Error' });\r\n-  }\r\n-};\r\n-\r\n-module.exports = {\r\n-  getBorrowHistoryWithDevice,\r\n-};\r\n"
                },
                {
                    "date": 1755097790643,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,16 +1,16 @@\n+// controllers/borrowHistoryController.js\r\n const pool = require('../config/db'); \r\n \r\n const getBorrowHistoryWithDevice = async (req, res) => {\r\n   try {\r\n     const sql = `\r\n       SELECT\r\n         d.id,\r\n+        dt.type_name,\r\n         d.name AS device_name,\r\n         d.brand,\r\n-        db.name AS brand_name,\r\n-        d.type,\r\n-        dt.name AS type_name,\r\n+        db.brand_name,\r\n         d.id_code,\r\n         d.serial_number,\r\n         bh.borrower_name,\r\n         bh.department,\r\n@@ -22,15 +22,36 @@\n       LEFT JOIN device_types dt ON d.type = dt.id\r\n       LEFT JOIN device_brand db ON d.brand = db.id\r\n       ORDER BY bh.borrowed_at DESC\r\n     `;\r\n+\r\n     const [rows] = await pool.query(sql);\r\n     res.json(rows);\r\n   } catch (error) {\r\n     console.error('Error in getBorrowHistoryWithDevice:', error);\r\n     res.status(500).json({ message: 'Internal Server Error' });\r\n   }\r\n };\r\n \r\n+// ดึงรายการ brand ทั้งหมด\r\n+exports.getAllBrands = async (req, res) => {\r\n+  try {\r\n+    const [brands] = await db.query('SELECT * FROM device_brand');\r\n+    res.json(brands);\r\n+  } catch (err) {\r\n+    res.status(500).json({ message: 'ดึงข้อมูล brand ไม่สำเร็จ', error: err.message });\r\n+  }\r\n+};\r\n+\r\n+// ดึงรายการ type ทั้งหมด\r\n+exports.getAllTypes = async (req, res) => {\r\n+  try {\r\n+    const [types] = await db.query('SELECT * FROM device_types');\r\n+    res.json(types);\r\n+  } catch (err) {\r\n+    res.status(500).json({ message: 'ดึงข้อมูล type ไม่สำเร็จ', error: err.message });\r\n+  }\r\n+};\r\n+\r\n module.exports = {\r\n   getBorrowHistoryWithDevice,\r\n };\r\n"
                },
                {
                    "date": 1755098295006,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,9 +7,8 @@\n       SELECT\r\n         d.id,\r\n         dt.type_name,\r\n         d.name AS device_name,\r\n-        d.brand,\r\n         db.brand_name,\r\n         d.id_code,\r\n         d.serial_number,\r\n         bh.borrower_name,\r\n@@ -22,36 +21,15 @@\n       LEFT JOIN device_types dt ON d.type = dt.id\r\n       LEFT JOIN device_brand db ON d.brand = db.id\r\n       ORDER BY bh.borrowed_at DESC\r\n     `;\r\n-\r\n     const [rows] = await pool.query(sql);\r\n     res.json(rows);\r\n   } catch (error) {\r\n     console.error('Error in getBorrowHistoryWithDevice:', error);\r\n     res.status(500).json({ message: 'Internal Server Error' });\r\n   }\r\n };\r\n \r\n-// ดึงรายการ brand ทั้งหมด\r\n-exports.getAllBrands = async (req, res) => {\r\n-  try {\r\n-    const [brands] = await db.query('SELECT * FROM device_brand');\r\n-    res.json(brands);\r\n-  } catch (err) {\r\n-    res.status(500).json({ message: 'ดึงข้อมูล brand ไม่สำเร็จ', error: err.message });\r\n-  }\r\n-};\r\n-\r\n-// ดึงรายการ type ทั้งหมด\r\n-exports.getAllTypes = async (req, res) => {\r\n-  try {\r\n-    const [types] = await db.query('SELECT * FROM device_types');\r\n-    res.json(types);\r\n-  } catch (err) {\r\n-    res.status(500).json({ message: 'ดึงข้อมูล type ไม่สำเร็จ', error: err.message });\r\n-  }\r\n-};\r\n-\r\n module.exports = {\r\n   getBorrowHistoryWithDevice,\r\n-};\r\n+};\n\\ No newline at end of file\n"
                },
                {
                    "date": 1755098466124,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,8 +7,9 @@\n       SELECT\r\n         d.id,\r\n         dt.type_name,\r\n         d.name AS device_name,\r\n+        d.brand,\r\n         db.brand_name,\r\n         d.id_code,\r\n         d.serial_number,\r\n         bh.borrower_name,\r\n@@ -21,15 +22,36 @@\n       LEFT JOIN device_types dt ON d.type = dt.id\r\n       LEFT JOIN device_brand db ON d.brand = db.id\r\n       ORDER BY bh.borrowed_at DESC\r\n     `;\r\n+\r\n     const [rows] = await pool.query(sql);\r\n     res.json(rows);\r\n   } catch (error) {\r\n     console.error('Error in getBorrowHistoryWithDevice:', error);\r\n     res.status(500).json({ message: 'Internal Server Error' });\r\n   }\r\n };\r\n \r\n+// ดึงรายการ brand ทั้งหมด\r\n+exports.getAllBrands = async (req, res) => {\r\n\\ No newline at end of file\n+  try {\r\n+    const [brands] = await db.query('SELECT * FROM device_brand');\r\n+    res.json(brands);\r\n+  } catch (err) {\r\n+    res.status(500).json({ message: 'ดึงข้อมูล brand ไม่สำเร็จ', error: err.message });\r\n+  }\r\n+};\r\n+\r\n+// ดึงรายการ type ทั้งหมด\r\n+exports.getAllTypes = async (req, res) => {\r\n+  try {\r\n+    const [types] = await db.query('SELECT * FROM device_types');\r\n+    res.json(types);\r\n+  } catch (err) {\r\n+    res.status(500).json({ message: 'ดึงข้อมูล type ไม่สำเร็จ', error: err.message });\r\n+  }\r\n+};\r\n+\r\n module.exports = {\r\n   getBorrowHistoryWithDevice,\r\n-};\n+};\r\n"
                },
                {
                    "date": 1755226898829,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,12 +1,22 @@\n-// controllers/borrowHistoryController.js\r\n const pool = require('../config/db'); \r\n \r\n+// ดึงประวัติการยืมทั้งหมด (รองรับ device_id เป็น NULL)\r\n const getBorrowHistoryWithDevice = async (req, res) => {\r\n   try {\r\n+    // ถ้ามีการกรองตามเดือน\r\n+    const { month, year } = req.query;\r\n+    let filter = '';\r\n+    let params = [];\r\n+\r\n+    if (month && year) {\r\n+      filter = 'WHERE MONTH(bh.borrowed_at) = ? AND YEAR(bh.borrowed_at) = ?';\r\n+      params.push(month, year);\r\n+    }\r\n+\r\n     const sql = `\r\n       SELECT\r\n-        d.id,\r\n+        d.id AS device_id,\r\n         dt.type_name,\r\n         d.name AS device_name,\r\n         d.brand,\r\n         db.brand_name,\r\n@@ -16,16 +26,17 @@\n         bh.department,\r\n         bh.reason,\r\n         bh.borrowed_at,\r\n         bh.returned_at\r\n-      FROM devices d\r\n-      INNER JOIN borrow_history bh ON bh.device_id = d.id\r\n+      FROM borrow_history bh\r\n+      LEFT JOIN devices d ON bh.device_id = d.id\r\n       LEFT JOIN device_types dt ON d.type = dt.id\r\n       LEFT JOIN device_brand db ON d.brand = db.id\r\n+      ${filter}\r\n       ORDER BY bh.borrowed_at DESC\r\n     `;\r\n \r\n-    const [rows] = await pool.query(sql);\r\n+    const [rows] = await pool.query(sql, params);\r\n     res.json(rows);\r\n   } catch (error) {\r\n     console.error('Error in getBorrowHistoryWithDevice:', error);\r\n     res.status(500).json({ message: 'Internal Server Error' });\r\n@@ -34,9 +45,9 @@\n \r\n // ดึงรายการ brand ทั้งหมด\r\n exports.getAllBrands = async (req, res) => {\r\n   try {\r\n-    const [brands] = await db.query('SELECT * FROM device_brand');\r\n+    const [brands] = await pool.query('SELECT * FROM device_brand');\r\n     res.json(brands);\r\n   } catch (err) {\r\n     res.status(500).json({ message: 'ดึงข้อมูล brand ไม่สำเร็จ', error: err.message });\r\n   }\r\n@@ -44,14 +55,16 @@\n \r\n // ดึงรายการ type ทั้งหมด\r\n exports.getAllTypes = async (req, res) => {\r\n   try {\r\n-    const [types] = await db.query('SELECT * FROM device_types');\r\n+    const [types] = await pool.query('SELECT * FROM device_types');\r\n     res.json(types);\r\n   } catch (err) {\r\n     res.status(500).json({ message: 'ดึงข้อมูล type ไม่สำเร็จ', error: err.message });\r\n   }\r\n };\r\n \r\n module.exports = {\r\n   getBorrowHistoryWithDevice,\r\n\\ No newline at end of file\n-};\n+  getAllBrands: exports.getAllBrands,\r\n+  getAllTypes: exports.getAllTypes\r\n+};\r\n"
                },
                {
                    "date": 1755227071379,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,22 +1,12 @@\n+// controllers/borrowHistoryController.js\r\n const pool = require('../config/db'); \r\n \r\n-// ดึงประวัติการยืมทั้งหมด (รองรับ device_id เป็น NULL)\r\n const getBorrowHistoryWithDevice = async (req, res) => {\r\n   try {\r\n-    // ถ้ามีการกรองตามเดือน\r\n-    const { month, year } = req.query;\r\n-    let filter = '';\r\n-    let params = [];\r\n-\r\n-    if (month && year) {\r\n-      filter = 'WHERE MONTH(bh.borrowed_at) = ? AND YEAR(bh.borrowed_at) = ?';\r\n-      params.push(month, year);\r\n-    }\r\n-\r\n     const sql = `\r\n       SELECT\r\n-        d.id AS device_id,\r\n+        d.id,\r\n         dt.type_name,\r\n         d.name AS device_name,\r\n         d.brand,\r\n         db.brand_name,\r\n@@ -26,17 +16,16 @@\n         bh.department,\r\n         bh.reason,\r\n         bh.borrowed_at,\r\n         bh.returned_at\r\n-      FROM borrow_history bh\r\n-      LEFT JOIN devices d ON bh.device_id = d.id\r\n+      FROM devices d\r\n+      INNER JOIN borrow_history bh ON bh.device_id = d.id\r\n       LEFT JOIN device_types dt ON d.type = dt.id\r\n       LEFT JOIN device_brand db ON d.brand = db.id\r\n-      ${filter}\r\n       ORDER BY bh.borrowed_at DESC\r\n     `;\r\n \r\n-    const [rows] = await pool.query(sql, params);\r\n+    const [rows] = await pool.query(sql);\r\n     res.json(rows);\r\n   } catch (error) {\r\n     console.error('Error in getBorrowHistoryWithDevice:', error);\r\n     res.status(500).json({ message: 'Internal Server Error' });\r\n@@ -45,9 +34,9 @@\n \r\n // ดึงรายการ brand ทั้งหมด\r\n exports.getAllBrands = async (req, res) => {\r\n   try {\r\n-    const [brands] = await pool.query('SELECT * FROM device_brand');\r\n+    const [brands] = await db.query('SELECT * FROM device_brand');\r\n     res.json(brands);\r\n   } catch (err) {\r\n     res.status(500).json({ message: 'ดึงข้อมูล brand ไม่สำเร็จ', error: err.message });\r\n   }\r\n@@ -55,16 +44,14 @@\n \r\n // ดึงรายการ type ทั้งหมด\r\n exports.getAllTypes = async (req, res) => {\r\n   try {\r\n-    const [types] = await pool.query('SELECT * FROM device_types');\r\n+    const [types] = await db.query('SELECT * FROM device_types');\r\n     res.json(types);\r\n   } catch (err) {\r\n     res.status(500).json({ message: 'ดึงข้อมูล type ไม่สำเร็จ', error: err.message });\r\n   }\r\n };\r\n \r\n module.exports = {\r\n   getBorrowHistoryWithDevice,\r\n-  getAllBrands: exports.getAllBrands,\r\n-  getAllTypes: exports.getAllTypes\r\n\\ No newline at end of file\n-};\n+};\r\n"
                },
                {
                    "date": 1755228635796,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,19 @@\n // controllers/borrowHistoryController.js\r\n const pool = require('../config/db'); \r\n \r\n+// ดึงประวัติการยืม (รองรับกรองเดือน/ปี)\r\n const getBorrowHistoryWithDevice = async (req, res) => {\r\n   try {\r\n+    const { month, year } = req.query;\r\n+    let filter = '';\r\n+    const params = [];\r\n+\r\n+    if (month && year) {\r\n+      filter = 'WHERE MONTH(bh.borrowed_at) = ? AND YEAR(bh.borrowed_at) = ?';\r\n+      params.push(month, year);\r\n+    }\r\n+\r\n     const sql = `\r\n       SELECT\r\n         d.id,\r\n         dt.type_name,\r\n@@ -16,42 +26,45 @@\n         bh.department,\r\n         bh.reason,\r\n         bh.borrowed_at,\r\n         bh.returned_at\r\n-      FROM devices d\r\n-      INNER JOIN borrow_history bh ON bh.device_id = d.id\r\n+      FROM borrow_history bh\r\n+      LEFT JOIN devices d ON bh.device_id = d.id\r\n       LEFT JOIN device_types dt ON d.type = dt.id\r\n       LEFT JOIN device_brand db ON d.brand = db.id\r\n+      ${filter}\r\n       ORDER BY bh.borrowed_at DESC\r\n     `;\r\n \r\n-    const [rows] = await pool.query(sql);\r\n+    const [rows] = await pool.query(sql, params);\r\n     res.json(rows);\r\n   } catch (error) {\r\n     console.error('Error in getBorrowHistoryWithDevice:', error);\r\n     res.status(500).json({ message: 'Internal Server Error' });\r\n   }\r\n };\r\n \r\n // ดึงรายการ brand ทั้งหมด\r\n-exports.getAllBrands = async (req, res) => {\r\n+const getAllBrands = async (req, res) => {\r\n   try {\r\n-    const [brands] = await db.query('SELECT * FROM device_brand');\r\n+    const [brands] = await pool.query('SELECT * FROM device_brand');\r\n     res.json(brands);\r\n   } catch (err) {\r\n     res.status(500).json({ message: 'ดึงข้อมูล brand ไม่สำเร็จ', error: err.message });\r\n   }\r\n };\r\n \r\n // ดึงรายการ type ทั้งหมด\r\n-exports.getAllTypes = async (req, res) => {\r\n+const getAllTypes = async (req, res) => {\r\n   try {\r\n-    const [types] = await db.query('SELECT * FROM device_types');\r\n+    const [types] = await pool.query('SELECT * FROM device_types');\r\n     res.json(types);\r\n   } catch (err) {\r\n     res.status(500).json({ message: 'ดึงข้อมูล type ไม่สำเร็จ', error: err.message });\r\n   }\r\n };\r\n \r\n module.exports = {\r\n   getBorrowHistoryWithDevice,\r\n+  getAllBrands,\r\n+  getAllTypes,\r\n };\r\n"
                },
                {
                    "date": 1759897302025,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,17 +3,27 @@\n \r\n // ดึงประวัติการยืม (รองรับกรองเดือน/ปี)\r\n const getBorrowHistoryWithDevice = async (req, res) => {\r\n   try {\r\n-    const { month, year } = req.query;\r\n-    let filter = '';\r\n+    const { day, month, year } = req.query;\r\n     const params = [];\r\n+    const conditions = [];\r\n \r\n-    if (month && year) {\r\n-      filter = 'WHERE MONTH(bh.borrowed_at) = ? AND YEAR(bh.borrowed_at) = ?';\r\n-      params.push(month, year);\r\n+    if (day) {\r\n+      conditions.push('DAY(bh.borrowed_at) = ?');\r\n+      params.push(day);\r\n     }\r\n+    if (month) {\r\n+      conditions.push('MONTH(bh.borrowed_at) = ?');\r\n+      params.push(month);\r\n+    }\r\n+    if (year) {\r\n+      conditions.push('YEAR(bh.borrowed_at) = ?');\r\n+      params.push(year);\r\n+    }\r\n \r\n+    const whereClause = conditions.length ? `WHERE ${conditions.join(' AND ')}` : '';\r\n+\r\n     const sql = `\r\n       SELECT\r\n         d.id,\r\n         dt.type_name,\r\n"
                },
                {
                    "date": 1759897355275,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -27,9 +27,8 @@\n       SELECT\r\n         d.id,\r\n         dt.type_name,\r\n         d.name AS device_name,\r\n-        d.brand,\r\n         db.brand_name,\r\n         d.id_code,\r\n         d.serial_number,\r\n         bh.borrower_name,\r\n@@ -40,9 +39,9 @@\n       FROM borrow_history bh\r\n       LEFT JOIN devices d ON bh.device_id = d.id\r\n       LEFT JOIN device_types dt ON d.type = dt.id\r\n       LEFT JOIN device_brand db ON d.brand = db.id\r\n-      ${filter}\r\n+      ${whereClause}\r\n       ORDER BY bh.borrowed_at DESC\r\n     `;\r\n \r\n     const [rows] = await pool.query(sql, params);\r\n"
                },
                {
                    "date": 1759898220357,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,24 +4,25 @@\n // ดึงประวัติการยืม (รองรับกรองเดือน/ปี)\r\n const getBorrowHistoryWithDevice = async (req, res) => {\r\n   try {\r\n     const { day, month, year } = req.query;\r\n-    const params = [];\r\n-    const conditions = [];\r\n+const params = [];\r\n+const conditions = [];\r\n \r\n-    if (day) {\r\n-      conditions.push('DAY(bh.borrowed_at) = ?');\r\n-      params.push(day);\r\n-    }\r\n-    if (month) {\r\n-      conditions.push('MONTH(bh.borrowed_at) = ?');\r\n-      params.push(month);\r\n-    }\r\n-    if (year) {\r\n-      conditions.push('YEAR(bh.borrowed_at) = ?');\r\n-      params.push(year);\r\n-    }\r\n+if (day) {\r\n+  conditions.push('DAY(bh.borrowed_at) = ?');\r\n+  params.push(Number(day));\r\n+}\r\n+if (month) {\r\n+  conditions.push('MONTH(bh.borrowed_at) = ?');\r\n+  params.push(Number(month));\r\n+}\r\n+if (year) {\r\n+  conditions.push('YEAR(bh.borrowed_at) = ?');\r\n+  params.push(Number(year));\r\n+}\r\n \r\n+\r\n     const whereClause = conditions.length ? `WHERE ${conditions.join(' AND ')}` : '';\r\n \r\n     const sql = `\r\n       SELECT\r\n"
                },
                {
                    "date": 1759898494691,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,28 +1,40 @@\n // controllers/borrowHistoryController.js\r\n const pool = require('../config/db'); \r\n \r\n-// ดึงประวัติการยืม (รองรับกรองเดือน/ปี)\r\n+// ดึงประวัติการยืม (รองรับกรองวัน/เดือน/ปี)\r\n const getBorrowHistoryWithDevice = async (req, res) => {\r\n   try {\r\n     const { day, month, year } = req.query;\r\n-const params = [];\r\n-const conditions = [];\r\n \r\n-if (day) {\r\n-  conditions.push('DAY(bh.borrowed_at) = ?');\r\n-  params.push(Number(day));\r\n-}\r\n-if (month) {\r\n-  conditions.push('MONTH(bh.borrowed_at) = ?');\r\n-  params.push(Number(month));\r\n-}\r\n-if (year) {\r\n-  conditions.push('YEAR(bh.borrowed_at) = ?');\r\n-  params.push(Number(year));\r\n-}\r\n+    const params = [];\r\n+    const conditions = [];\r\n \r\n+    // ตรวจสอบค่าและแปลงเป็น number เฉพาะเมื่อมีค่า\r\n+    if (day !== undefined && day !== \"\") {\r\n+      const d = Number(day);\r\n+      if (!isNaN(d)) {\r\n+        conditions.push('DAY(bh.borrowed_at) = ?');\r\n+        params.push(d);\r\n+      }\r\n+    }\r\n \r\n+    if (month !== undefined && month !== \"\") {\r\n+      const m = Number(month);\r\n+      if (!isNaN(m)) {\r\n+        conditions.push('MONTH(bh.borrowed_at) = ?');\r\n+        params.push(m);\r\n+      }\r\n+    }\r\n+\r\n+    if (year !== undefined && year !== \"\") {\r\n+      const y = Number(year);\r\n+      if (!isNaN(y)) {\r\n+        conditions.push('YEAR(bh.borrowed_at) = ?');\r\n+        params.push(y);\r\n+      }\r\n+    }\r\n+\r\n     const whereClause = conditions.length ? `WHERE ${conditions.join(' AND ')}` : '';\r\n \r\n     const sql = `\r\n       SELECT\r\n@@ -58,8 +70,9 @@\n   try {\r\n     const [brands] = await pool.query('SELECT * FROM device_brand');\r\n     res.json(brands);\r\n   } catch (err) {\r\n+    console.error('Error in getAllBrands:', err);\r\n     res.status(500).json({ message: 'ดึงข้อมูล brand ไม่สำเร็จ', error: err.message });\r\n   }\r\n };\r\n \r\n@@ -68,8 +81,9 @@\n   try {\r\n     const [types] = await pool.query('SELECT * FROM device_types');\r\n     res.json(types);\r\n   } catch (err) {\r\n+    console.error('Error in getAllTypes:', err);\r\n     res.status(500).json({ message: 'ดึงข้อมูล type ไม่สำเร็จ', error: err.message });\r\n   }\r\n };\r\n \r\n"
                },
                {
                    "date": 1759898636689,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,28 +8,31 @@\n \r\n     const params = [];\r\n     const conditions = [];\r\n \r\n-    // ตรวจสอบค่าและแปลงเป็น number เฉพาะเมื่อมีค่า\r\n+    // กรองวัน\r\n     if (day !== undefined && day !== \"\") {\r\n       const d = Number(day);\r\n       if (!isNaN(d)) {\r\n         conditions.push('DAY(bh.borrowed_at) = ?');\r\n         params.push(d);\r\n       }\r\n     }\r\n \r\n+    // กรองเดือน\r\n     if (month !== undefined && month !== \"\") {\r\n       const m = Number(month);\r\n       if (!isNaN(m)) {\r\n         conditions.push('MONTH(bh.borrowed_at) = ?');\r\n         params.push(m);\r\n       }\r\n     }\r\n \r\n+    // กรองปี (รองรับ พ.ศ. → ค.ศ.)\r\n     if (year !== undefined && year !== \"\") {\r\n-      const y = Number(year);\r\n+      let y = Number(year);\r\n       if (!isNaN(y)) {\r\n+        if (y > 2500) y -= 543; // แปลงพุทธศักราชเป็นคริสต์ศักราช\r\n         conditions.push('YEAR(bh.borrowed_at) = ?');\r\n         params.push(y);\r\n       }\r\n     }\r\n"
                }
            ],
            "date": 1754818141434,
            "name": "Commit-0",
            "content": "const pool = require('../config/db'); // สมมติคุณสร้าง pool ไว้ที่นี่\r\n\r\nconst getBorrowHistoryWithDevice = async (req, res) => {\r\n  try {\r\n    const sql = `\r\n      SELECT\r\n        d.type,\r\n        d.name AS device_name,\r\n        d.brand,\r\n        d.id_code,\r\n        d.serial_number,\r\n        bh.borrower_name,\r\n        bh.department,\r\n        bh.reason,\r\n        bh.borrowed_at,\r\n        bh.returned_at\r\n      FROM devices d\r\n      LEFT JOIN borrow_history bh ON bh.device_id = d.id\r\n      ORDER BY bh.borrowed_at DESC\r\n    `;\r\n\r\n    const [rows] = await pool.query(sql);\r\n    res.json(rows);\r\n  } catch (error) {\r\n    console.error('Error in getBorrowHistoryWithDevice:', error);\r\n    res.status(500).json({ message: 'Internal Server Error' });\r\n  }\r\n};\r\n\r\nmodule.exports = {\r\n  getBorrowHistoryWithDevice,\r\n};\r\n"
        }
    ]
}